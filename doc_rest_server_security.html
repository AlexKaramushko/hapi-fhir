




 

 
 
 

     <!doctype html>
<!--
 Generated by Apache Maven Doxia  at 2019-08-09  Rendered using Reflow Maven Skin 2.0.0-beta2 (http://devacfr.github.io/reflow-maven-skin)
-->
<html  xml:lang="en" lang="en">
                                                                    
                    <head>
    <meta charset="UTF-8" />
    <title>Server Security - HAPI FHIR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
      <meta http-equiv="content-language" content="en" />
                                                        <link href="https://netdna.bootstrapcdn.com/bootswatch/4.1.3/lumen/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">
    <link href="./css/docs.css" rel="stylesheet" />
    <link href="./css/reflow-skin.css" rel="stylesheet" />

    <link href="./css/lightbox.css" rel="stylesheet" />
    <link href="./css/site.css" rel="stylesheet" />
    <link href="./css/print.css" rel="stylesheet" media="print" />
<!-- Syntax Highlighter -->
			<script type="text/javascript" src="syntaxhighlighter/shCore.js"></script>
			<script type="text/javascript" src="syntaxhighlighter/shBrushJScript.js"></script>
			<script type="text/javascript" src="syntaxhighlighter/shBrushJava.js"></script>
			<script type="text/javascript" src="syntaxhighlighter/shBrushBash.js"></script>
			<script type="text/javascript" src="syntaxhighlighter/shBrushXml.js"></script>
			
			<link href="syntaxhighlighter/shCore.css" rel="stylesheet" type="text/css" />
			<link href="syntaxhighlighter/shThemeDefault.css" rel="stylesheet" type="text/css" />
			
			<!-- 
			   HAPI stylesheet comes after because it overwrites the Syntax Highlighter
			   font size
			 -->
			<link rel="shortcut icon" href="http://hapifhir.io/favicon.png" />
			<link rel="stylesheet" type="text/css" href="hapi.css" />
        </head> <!-- end : head -->
<body class="page-doc_rest_server_security project-hapi-fhir   scroll-top-smooth-enabled m-toc-sidebar-enabled m-toc-sidebar-expanded m-toc-sidebar-autoexpandable toc-sidebar-fixed">
    <nav id="m-top-navbar" class="navbar navbar-expand-lg fixed-top navbar-dark bg-primary border-bottom">
        <div class="container">
                                <a class="navbar-brand mb-0 h1" href="http://hapifhir.io"><span class="color-highlight">HAPI</span> FHIR</a>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#top-navbar-collapse-1" aria-controls="top-navbar-collapse-1" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="top-navbar-collapse-1">
                <ul class="nav navbar-nav ml-auto">
<li class="nav-item " ><a     
     href="https://smilecdr.com"  title="Support"   class="externalLink nav-link" >Support</a></li>
<li class="nav-item " ><a     
     href="download.html"  title="Download"  class="nav-link" >Download</a></li>
<li class="nav-item " ><a     
     href="https://github.com/jamesagnew/hapi-fhir"  title="GitHub Project"   class="externalLink nav-link" >GitHub Project</a></li>
                            <li class="nav-item dropdown active">
                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Documentation <b class="caret"></b></a>
                <div class="dropdown-menu">
                    <a href="docindex.html" title="Documentation Index"  class="dropdown-item ">Documentation Index</a>
                    <a href="doc_intro.html" title="Introduction"  class="dropdown-item ">Introduction</a>
                    <a href="doc_dstu2.html" title="DSTU3 Support / HL7.org Structures"  class="dropdown-item ">DSTU3 Support / HL7.org Structures</a>
                    <div class="dropdown-submenu ">
    <a     
     href="doc_fhirobjects.html"  title="The Data Model"  class="dropdown-item" >The Data Model</a>                        <div class="dropdown-menu">
                                <a href="doc_fhirobjects.html" title="Working with Resources"  class="dropdown-item ">Working with Resources</a>
                                <a href="doc_resource_references.html" title="Resource References"  class="dropdown-item ">Resource References</a>
                                <a href="doc_extensions.html" title="Profiles & Extensions"  class="dropdown-item ">Profiles & Extensions</a>
                                <a href="doc_tags.html" title="Tags"  class="dropdown-item ">Tags</a>
                                <a href="doc_validation.html" title="Validation"  class="dropdown-item ">Validation</a>
                                <a href="doc_custom_structures.html" title="Custom Structures"  class="dropdown-item ">Custom Structures</a>
                                <a href="doc_converter.html" title="Version Converter"  class="dropdown-item ">Version Converter</a>
                            </div>
                    </div>
                    <div class="dropdown-submenu ">
    <a     
     href="doc_rest_client.html"  title="RESTful Client"  class="dropdown-item" >RESTful Client</a>                        <div class="dropdown-menu">
                                <a href="doc_rest_client.html" title="Fluent/Generic Client"  class="dropdown-item ">Fluent/Generic Client</a>
                                <a href="doc_rest_client_annotation.html" title="Annotation Client"  class="dropdown-item ">Annotation Client</a>
                                <a href="doc_rest_client_interceptor.html" title="Interceptors (client)"  class="dropdown-item ">Interceptors (client)</a>
                                <a href="doc_rest_client_http_config.html" title="Client Configuration"  class="dropdown-item ">Client Configuration</a>
                                <a href="doc_rest_client_examples.html" title="Client Examples"  class="dropdown-item ">Client Examples</a>
                                <a href="doc_rest_client_alternate_provider.html" title="JAX-RS Client & Alternate HTTP Providers"  class="dropdown-item ">JAX-RS Client & Alternate HTTP Providers</a>
                            </div>
                    </div>
                    <div class="dropdown-submenu ">
    <a     
     href="doc_rest_server.html"  title="RESTful Server"  class="dropdown-item" >RESTful Server</a>                        <div class="dropdown-menu">
                                <a href="doc_rest_server.html" title="Using RESTful Server"  class="dropdown-item ">Using RESTful Server</a>
                                <a href="doc_rest_operations.html" title="RESTful Operations"  class="dropdown-item ">RESTful Operations</a>
                                <a href="doc_narrative.html" title="Narrative Generator"  class="dropdown-item ">Narrative Generator</a>
                                <a href="doc_rest_server_interceptor.html" title="Interceptors (server)"  class="dropdown-item ">Interceptors (server)</a>
                                                <a href="" title="Security"  class="dropdown-item active">Security</a>
                                <a href="doc_cors.html" title="CORS Support"  class="dropdown-item ">CORS Support</a>
                                <a href="doc_server_tester.html" title="Web Testing UI"  class="dropdown-item ">Web Testing UI</a>
                                <a href="doc_rest_server_jaxrs.html" title="JAX-RS Support"  class="dropdown-item ">JAX-RS Support</a>
                            </div>
                    </div>
                    <a href="doc_logging.html" title="Logging"  class="dropdown-item ">Logging</a>
                    <a href="doc_rest_etag.html" title="ETags"  class="dropdown-item ">ETags</a>
                    <a href="doc_jpa.html" title="JPA/Database Server"  class="dropdown-item ">JPA/Database Server</a>
                    <a href="doc_android.html" title="Android Support"  class="dropdown-item ">Android Support</a>
                    <div class="dropdown-submenu ">
    <a     
     href="apidocs/index.html"  title="JavaDocs"  class="dropdown-item" >JavaDocs</a>                        <div class="dropdown-menu">
                                <a href="apidocs/index.html" title="Core API"  class="dropdown-item ">Core API</a>
                                <a href="apidocs-dstu2/index.html" title="Model API (DSTU2)"  class="dropdown-item ">Model API (DSTU2)</a>
                                <a href="apidocs-dstu3/index.html" title="Model API (DSTU3)"  class="dropdown-item ">Model API (DSTU3)</a>
                                <a href="apidocs-r4/index.html" title="Model API (R4)"  class="dropdown-item ">Model API (R4)</a>
                                <a href="apidocs-client/index.html" title="Client API"  class="dropdown-item ">Client API</a>
                                <a href="apidocs-server/index.html" title="Server API (Plain)"  class="dropdown-item ">Server API (Plain)</a>
                                <a href="apidocs-jpaserver/index.html" title="Server API (JPA)"  class="dropdown-item ">Server API (JPA)</a>
                            </div>
                    </div>
                    <a href="doc_cli.html" title="Command Line Tool (hapi-fhir-cli)"  class="dropdown-item ">Command Line Tool (hapi-fhir-cli)</a>
                    <a href="doc_tinder.html" title="Maven Plugin (hapi-tinder-plugin)"  class="dropdown-item ">Maven Plugin (hapi-tinder-plugin)</a>
                </div>
            </li>
            <li class="nav-item dropdown">
                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Get Help <b class="caret"></b></a>
                <div class="dropdown-menu">
                    <a href="https://github.com/jamesagnew/hapi-fhir/wiki/Getting-Help" title="How to Ask for Help (read this first!)"  class="dropdown-item ">How to Ask for Help (read this first!)</a>
                    <a href="https://groups.google.com/d/forum/hapi-fhir" title="Google Group (Ask Questions)"  class="dropdown-item ">Google Group (Ask Questions)</a>
                    <a href="https://github.com/jamesagnew/hapi-fhir/issues" title="Issue Tracker (Report Bugs/Request Features)"  class="dropdown-item ">Issue Tracker (Report Bugs/Request Features)</a>
                    <a href="https://chat.fhir.org" title="FHIR.org Chat (Live Chat with FHIR Implementors)"  class="dropdown-item ">FHIR.org Chat (Live Chat with FHIR Implementors)</a>
                    <a href="hapi-fhir-faq.html" title="Frequently Asked Questions (FAQ)"  class="dropdown-item ">Frequently Asked Questions (FAQ)</a>
                </div>
            </li>
            <li class="nav-item dropdown">
                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Test Server <b class="caret"></b></a>
                <div class="dropdown-menu">
                    <a href="http://hapi.fhir.org" title="Public Test Server"  class="dropdown-item ">Public Test Server</a>
                </div>
            </li>
                </ul><!--/ul.navbar-nav -->
            </div><!--/.nav-collapse -->
        </div> <!--/.container -->
    </nav> <!--/.navbar -->
    <div class="main-body container-fuild my-3">
    <div class="row m-0">
        <div class="d-xs-none d-sm-none d-md-none d-lg-block col-lg-2">
        </div>
        <main class="col-xs-12 col-sm-12 col-md-12 col-lg-12 col-xl-8" role="main">
            <div class="header container-fluid">
                                     <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a     
     href="index.html"  title="HAPI FHIR"  class="" >HAPI FHIR</a></li>
            <li class="breadcrumb-item active">Server Security</li>

        </ol>
    </nav>
            </div> <!-- end : header -->
                             <div class="section"> 
 <div class="page-header">
  <h2 id="_toc_server_security">Server Security</h2>
 </div> 
 <p> Security is a complex topic which goes far beyond the scope of HAPI FHIR. HAPI does provide mechanisms which can be used to implement security in your server however. </p> 
 <p> Because HAPI FHIR's REST server is based on the Servlet API, you may use any security mechanism which works in that environment. Some serlvet containers may provide security layers you can plug into. The rest of this page does not explore that method, but rather looks at HAPI FHIR hooks that can be used to implement FHIR specific security. </p> 
 <div class="section"> 
  <h3 id="_toc_authentication_vs_authorization">Authentication vs Authorization</h3> 
  <p> Background reading: <a class="externalLink" href="https://en.wikipedia.org/wiki/Authentication">Wikipedia - Authentication</a> </p> 
  <p> Server security is divided into three topics: </p> 
  <ul> 
   <li> <b>Authentication (AuthN):</b> Is verifying that the user is who they say they are. This is typically accomplished by testing a username/password in the request, or by checking a "bearer token" in the request. </li> 
   <li> <b>Authorization (AuthZ):</b> Is verifying that the user is allowed to perform the given action. For example, in a FHIR application you might use AuthN to test that the user making a request to the FHIR server is allowed to access the server, but that test might determine that the requesting user is not permitted to perform write operations and therefore block a FHIR <code class="\&quot;literal\&quot;">create</code> operation. This is AuthN and AuthZ in action. </li> 
   <li> <b>Consent and Audit:</b> Is verifying that a user has rights to see/modify the specific resources they are requesting, applying any directives to mask data being returned to the client (either partially or completely), and creating a record that the event occurred. </li> 
  </ul> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="_toc_authentication_interceptors">Authentication Interceptors</h2> 
 <p> The <a href="./doc_rest_server_interceptor.html">Server Interceptor</a> framework can provide an easy way to test for credentials. The following example shows a simple interceptor which tests for HTTP Basic Auth. </p> 
 <div class="source"> 
  <pre>public class BasicSecurityInterceptor extends InterceptorAdapter
{

   /**
    * This interceptor implements HTTP Basic Auth, which specifies that
    * a username and password are provided in a header called Authorization.
    */
   @Override
   public boolean incomingRequestPostProcessed(RequestDetails theRequestDetails, HttpServletRequest theRequest, HttpServletResponse theResponse) throws AuthenticationException {
      String authHeader = theRequest.getHeader("Authorization");
      
      // The format of the header must be:
      // Authorization: Basic [base64 of username:password]
      if (authHeader == null || authHeader.startsWith("Basic ") == false) {
         throw new AuthenticationException("Missing or invalid Authorization header");
      }
      
      String base64 = authHeader.substring("Basic ".length());
      String base64decoded = new String(Base64.decodeBase64(base64));
      String[] parts = base64decoded.split("\\:");
      
      String username = parts[0];
      String password = parts[1];
      
      /*
       * Here we test for a hardcoded username &amp; password. This is 
       * not typically how you would implement this in a production
       * system of course..
       */
      if (!username.equals("someuser") || !password.equals("thepassword")) {
         throw new AuthenticationException("Invalid username or password");
      }
      
      // Return true to allow the request to proceed
      return true;
   }

   
}
</pre> 
 </div> 
 <div class="section"> 
  <h3 id="_toc_http_basic_auth">HTTP Basic Auth</h3> 
  <p> Note that if you are implementing HTTP Basic Auth, you may want to return a <code class="\&quot;literal\&quot;">WWW-Authenticate</code> header with the response. The following snippet shows how to add such a header with a custom realm: </p> 
  <div class="source"> 
   <pre>AuthenticationException ex = new AuthenticationException();
ex.addAuthenticateHeaderForRealm("myRealm");
throw ex;
</pre> 
  </div> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="_toc_authorization_interceptor">Authorization Interceptor</h2> 
 <p> HAPI FHIR 1.5 introduced a new interceptor, the <a href="./apidocs-server/ca/uhn/fhir/rest/server/interceptor/auth/AuthorizationInterceptor.html">AuthorizationInterceptor</a>. </p> 
 <p> This interceptor can help with the complicated task of determining whether a user has the appropriate permission to perform a given task on a FHIR server. This is done by declaring a set of rules that can selectively allow (whitelist) and/or selectively block (blacklist) requests. </p> 
 <p class="doc_info_bubble"> AuthorizationInterceptor has been well tested, but it is impossible to predeict every scenario and environment in which HAPI FHIR will be used. Use with caution, and do lots of testing! We welcome feedback and suggestions on this feature. Please get in touch if you'd like to help test, have suggestions, etc. </p> 
 <p> The AuthorizationInterceptor works by allowing you to declare permissions based on an individual request coming in. In other words, you could have code that examines an incoming request and determines that it is being made by a Patient with ID 123. You could then declare that the requesting user has access to read and write any resource in compartment "Patient/123", which corresponds to any Observation, MedicationOrder etc with a subject of "<code class="\&quot;literal\&quot;">Patient/123</code>". On the other hand, another request might be detemrined to belong to an administrator user, and could be declared to be allowed to do anything. </p> 
 <p> The AuthorizationInterceptor is used by subclassing it and then registering your subclass with the <code class="\&quot;literal\&quot;">RestfulServer</code>. The following example shows a subclassed interceptor implementing some basic rules: </p> 
 <div class="source"> 
  <pre>   @SuppressWarnings("ConstantConditions")
	public class PatientAndAdminAuthorizationInterceptor extends AuthorizationInterceptor {
      
      @Override
      public List&lt;IAuthRule&gt; buildRuleList(RequestDetails theRequestDetails) {
         
         // Process authorization header - The following is a fake 
         // implementation. Obviously we'd want something more real
         // for a production scenario.
         // 
         // In this basic example we have two hardcoded bearer tokens,
         // one which is for a user that has access to one patient, and
         // another that has full access. 
         IdDt userIdPatientId = null;
         boolean userIsAdmin = false;
         String authHeader = theRequestDetails.getHeader("Authorization");
         if ("Bearer dfw98h38r".equals(authHeader)) {
            // This user has access only to Patient/1 resources
            userIdPatientId = new IdDt("Patient", 1L);
         } else if ("Bearer 39ff939jgg".equals(authHeader)) {
            // This user has access to everything
            userIsAdmin = true;
         } else {
            // Throw an HTTP 401
            throw new AuthenticationException("Missing or invalid Authorization header value");
         }

         // If the user is a specific patient, we create the following rule chain:
         // Allow the user to read anything in their own patient compartment
         // Allow the user to write anything in their own patient compartment
         // If a client request doesn't pass either of the above, deny it
         if (userIdPatientId != null) {
            return new RuleBuilder()
               .allow().read().allResources().inCompartment("Patient", userIdPatientId).andThen()
               .allow().write().allResources().inCompartment("Patient", userIdPatientId).andThen()
               .denyAll()
               .build();
         }
         
         // If the user is an admin, allow everything
         if (userIsAdmin) {
            return new RuleBuilder()
               .allowAll()
               .build();
         }
         
         // By default, deny everything. This should never get hit, but it's 
         // good to be defensive
         return new RuleBuilder()
            .denyAll()
            .build();
      }
   }
</pre> 
 </div> 
 <div class="section"> 
  <h3 id="_toc_using_authorizationinterceptor_in_a_rest_server">Using AuthorizationInterceptor in a REST Server</h3> 
  <p> The AuthorizationInterceptor works by examining the client request in order to determine whether "write" operations are legal, and looks at the response from the server in order to determine whether "read" operations are legal. </p> 
 </div> 
 <div class="section"> 
  <h3 id="_toc_authorizing_read_operations">Authorizing Read Operations</h3> 
  <p> When authorizing a read operation, the AuthorizationInterceptor always allows client code to execute and generate a response. It then examines the response that would be returned before actually returning it to the client, and if rules do not permit that data to be shown to the client the interceptor aborts the request. </p> 
  <p> Note that there are performance implications to this mechanism, since an unauthorized user can still cause the server to fetch data even if they won't get to see it. This mechanism should be comprehensive however, since it will prevent clients from using various features in FHIR (e.g. <code class="\&quot;literal\&quot;">_include</code> or <code class="\&quot;literal\&quot;">_revinclude</code>) to "trick" the server into showing them date they shouldn't be allowed to see. </p> 
  <p> See the following diagram for an example of how this works. </p> 
  <img src="./images/hapi_authorizationinterceptor_read_normal.svg" alt="Write Authorization" class="img-fluid"> 
 </div> 
 <div class="section"> 
  <h3 id="_toc_authorizing_write_operations">Authorizing Write Operations</h3> 
  <p> Write operations (create, update, etc.) are typically authorized by the interceptor by examining the parsed URL and making a decision about whether to authorize the operation before allowing Resource Provider code to proceed. This means that client code will not have a chance to execute and create resources that the client does not have permissions to create. </p> 
  <p> See the following diagram for an example of how this works. </p> 
  <img src="./images/hapi_authorizationinterceptor_write_normal.svg" alt="Write Authorization" class="img-fluid"> 
 </div> 
 <div class="section"> 
  <h3 id="_toc_authorizing_sub-operations">Authorizing Sub-Operations</h3> 
  <p> There are a number of situations where the REST framework doesn't actually know exactly what operation is going to be performed by the implementing server code. For example, if your server implements a <code class="\&quot;literal\&quot;">conditional update</code> operation, the server might not know which resource is actually being updated until the server code is executed. </p> 
  <p> Because client code is actually determining which resources are being modified, the server can not automatically apply security rules against these modifications without being provided hints from client code. </p> 
  <p> In this type of situation, it is important to manually notify the interceptor chain about the "sub-operation" being performed. The following snippet shows how to notify interceptors about a conditional create. </p> 
  <div class="source"> 
   <pre>   @Update()
   public MethodOutcome update(
         @IdParam IdDt theId, 
         @ResourceParam Patient theResource, 
         @ConditionalUrlParam String theConditionalUrl, 
         ServletRequestDetails theRequestDetails,
			IInterceptorBroadcaster theInterceptorBroadcaster) {

      // If we're processing a conditional URL...
      if (isNotBlank(theConditionalUrl)) {
         
         // Pretend we've done the conditional processing. Now let's
         // notify the interceptors that an update has been performed
         // and supply the actual ID that's being updated
         IdDt actual = new IdDt("Patient", "1123");
         
      }
      
      // In a real server, perhaps we would process the conditional 
      // request differently and follow a separate path. Either way,
      // let's pretend there is some storage code here.
      theResource.setId(theId.withVersion("2"));

      // Notify the interceptor framework when we're about to perform an update. This is
		// useful as the authorization interceptor will pick this event up and use it
		// to factor into a decision about whether the operation should be allowed to proceed.
		IBaseResource previousContents = theResource;
		IBaseResource newContents = theResource;
		HookParams params = new HookParams()
			.add(IBaseResource.class, previousContents)
			.add(IBaseResource.class, newContents)
			.add(RequestDetails.class, theRequestDetails)
			.add(ServletRequestDetails.class, theRequestDetails);
		theInterceptorBroadcaster.callHooks(Pointcut.STORAGE_PRESTORAGE_RESOURCE_UPDATED, params);

      MethodOutcome retVal = new MethodOutcome();
      retVal.setCreated(true);
      retVal.setResource(theResource);
      return retVal;
   }
</pre> 
  </div> 
 </div> 
 <div class="section"> 
  <h3 id="_toc_authorizing_patch_operations">Authorizing Patch Operations</h3> 
  <p> The FHIR <a class="externalLink" href="http://hl7.org/fhir/http.html#patch">patch</a> operation presents a challenge for authorization, as the incoming request often contains very little detail about what is being modified. </p> 
  <p> In order to properly enforce authorization on a server that allows the patch operation, a rule may be added that allows all patch requests, as shown below. </p> 
  <p> This should be combined with server support for <a class="externalLink" href="http://hapifhir.io/doc_rest_server_security.html#Authorizing_Sub-Operations">Authorizing Sub-Operations</a> as shown above. </p> 
  <div class="source"> 
   <pre>		new AuthorizationInterceptor(PolicyEnum.DENY) {
			@Override
			public List&lt;IAuthRule&gt; buildRuleList(RequestDetails theRequestDetails) {
				return new RuleBuilder()
					// Authorize patch requests
					.allow().patch().allRequests().andThen()
					// Authorize actual writes that patch may perform
					.allow().write().allResources().inCompartment("Patient", new IdType("Patient/123")).andThen()
					.build();
			}
		};
</pre> 
  </div> 
 </div> 
 <div class="section"> 
  <h3 id="_toc_authorizing_multitenant_servers">Authorizing Multitenant Servers</h3> 
  <p> The AuthorizationInterceptor has the ability to direct individual rules as only applying to a single tenant in a multitenant server. The following example shows such a rule. </p> 
  <div class="source"> 
   <pre>		new AuthorizationInterceptor(PolicyEnum.DENY) {
			@Override
			public List&lt;IAuthRule&gt; buildRuleList(RequestDetails theRequestDetails) {
				return new RuleBuilder()
					.allow().read().resourcesOfType(Patient.class).withAnyId().forTenantIds("TENANTA").andThen()
					.build();
			}
		};
</pre> 
  </div> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="_toc_consent_interceptor">Consent Interceptor</h2> 
 <p> HAPI FHIR 4.0.0 introduced a new interceptor, the <a href="./apidocs/ca/uhn/fhir/rest/server/interceptor/consent/ConsentInterceptor.html">ConsentInterceptor</a>. </p> 
 <p> The consent interceptor may be used to examine client requests to apply consent directives and create audit trail events. Like the AuthorizationInterceptor above, this interceptor is not a complete working solution, but instead is a framework designed to make it easier to implement local policies. </p> 
 <p> The consent interceptor has several primary purposes: </p> 
 <ul> 
  <li> It can reject a resource from being disclosed to the user by examining it while calculating search results. This calculation is performed very early in the process of building search results, in order to ensure that in many cases the user is unaware that results have been removed. </li> 
  <li> It can redact results, removing specific elements before they are returned to a client. </li> 
  <li> It can create audit trail records (e.g. using an AuditEvent resource) </li> 
  <li> It can apply consent directives (e.g. by reading relevant Consent resources) </li> 
  <li> The consent service suppresses search the total being returned in Bundle.total for search results. </li> 
 </ul> 
 <p> The ConsentInterceptor requires a user-supplied instance of the <a href="./apidocs/ca/uhn/fhir/rest/server/interceptor/consent/IConsentService.html">IConsentService</a> interface. The following shows a simple example of an IConsentService implementation: </p> 
 <div class="source"> 
  <pre>	public class MyConsentService implements IConsentService {

		/**
		 * Invoked once at the start of every request
		 */
		@Override
		public ConsentOutcome startOperation(RequestDetails theRequestDetails, IConsentContextServices theContextServices) {
			// This means that all requests should flow through the consent service
			// This has performance implications - If you know that some requests
			// don't need consent checking it is a good idea to return
			// ConsentOutcome.AUTHORIZED instead for those requests.
			return ConsentOutcome.PROCEED;
		}

		/**
		 * Can a given resource be returned to the user?
		 */
		@Override
		public ConsentOutcome canSeeResource(RequestDetails theRequestDetails, IBaseResource theResource, IConsentContextServices theContextServices) {
			// In this basic example, we will filter out lab results so that they
			// are never disclosed to the user. A real interceptor might do something
			// more nuanced.
			if (theResource instanceof Observation) {
				Observation obs = (Observation)theResource;
				if (obs.getCategoryFirstRep().hasCoding("http://hl7.org/fhir/codesystem-observation-category.html", "laboratory")) {
					return ConsentOutcome.REJECT;
				}
			}

			// Otherwise, allow the
			return ConsentOutcome.PROCEED;
		}

		/**
		 * Modify resources that are being shown to the user
		 */
		@Override
		public ConsentOutcome willSeeResource(RequestDetails theRequestDetails, IBaseResource theResource, IConsentContextServices theContextServices) {
			// Don't return the subject for Observation resources
			if (theResource instanceof Observation) {
				Observation obs = (Observation)theResource;
				obs.setSubject(null);
			}
			return ConsentOutcome.AUTHORIZED;
		}

		@Override
		public void completeOperationSuccess(RequestDetails theRequestDetails, IConsentContextServices theContextServices) {
			// We could write an audit trail entry in here
		}

		@Override
		public void completeOperationFailure(RequestDetails theRequestDetails, BaseServerResponseException theException, IConsentContextServices theContextServices) {
			// We could write an audit trail entry in here
		}
	}
</pre> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="_toc_search_narrowing">Search Narrowing</h2> 
 <p> HAPI FHIR 3.7.0 introduced a new interceptor, the <a href="./apidocs/ca/uhn/fhir/rest/server/interceptor/auth/SearchNarrowingInterceptor.html">SearchNarrowingInterceptor</a>. </p> 
 <p> This interceptor is designed to be used in conjunction with AuthorizationInterceptor. It uses a similar strategy where a dynamic list is built up for each request, but the purpose of this interceptor is to modify client searches that are received (after HAPI FHIR received the HTTP request, but before the search is actually performed) to restrict the search to only search for specific resources or compartments that the user has access to. </p> 
 <p> This could be used, for example, to allow the user to perform a search for<br> <code class="\&quot;literal\&quot;">http://baseurl/Observation?category=laboratory</code><br> and then receive results as though they had requested<br> <code class="\&quot;literal\&quot;">http://baseurl/Observation?subject=Patient/123&amp;category=laboratory</code>. </p> 
 <p> An example of this interceptor follows: </p> 
 <div class="source"> 
  <pre>	public class MyPatientSearchNarrowingInterceptor extends SearchNarrowingInterceptor {

		/**
		 * This method must be overridden to provide the list of compartments
		 * and/or resources that the current user should have access to
		 */
		@Override
		protected AuthorizedList buildAuthorizedList(RequestDetails theRequestDetails) {
			// Process authorization header - The following is a fake
			// implementation. Obviously we'd want something more real
			// for a production scenario.
			//
			// In this basic example we have two hardcoded bearer tokens,
			// one which is for a user that has access to one patient, and
			// another that has full access.
			String authHeader = theRequestDetails.getHeader("Authorization");
			if ("Bearer dfw98h38r".equals(authHeader)) {

				// This user will have access to two compartments
				return new AuthorizedList()
					.addCompartment("Patient/123")
					.addCompartment("Patient/456");

			} else if ("Bearer 39ff939jgg".equals(authHeader)) {

				// This user has access to everything
				return new AuthorizedList();

			} else {

				throw new AuthenticationException("Unknown bearer token");

			}

		}

	}
</pre> 
 </div> 
</div>                    </main>
        <div class="d-none d-sm-none d-md-none d-lg-none d-xl-block col-xl-2">
                        <div id="m-toc-sidebar" class="d-print-none m-toc-sidebar-enabled m-toc-sidebar-expanded m-toc-sidebar-autoexpandable toc-sidebar-fixed">
                <nav id="m-toc-sidebar-nav flex-column">
                <ul class="m-nav--sidebar nav flex-column flex-nowrap">
    <li class="h2">
        <a class="nav-link" href="#_toc_server_security" title="Server Security">Server Security</a>
    </li>
    <ul class="nav flex-column flex-nowrap nav-collapsible">
        <li class="h3">
        <a class="nav-link" href="#_toc_authentication_vs_authorization" title="Authentication vs Authorization">Authentication vs Authorization</a>
    </li>
    </ul>
        <li class="h2">
        <a class="nav-link" href="#_toc_authentication_interceptors" title="Authentication Interceptors">Authentication Interceptors</a>
    </li>
    <ul class="nav flex-column flex-nowrap nav-collapsible">
        <li class="h3">
        <a class="nav-link" href="#_toc_http_basic_auth" title="HTTP Basic Auth">HTTP Basic Auth</a>
    </li>
    </ul>
        <li class="h2">
        <a class="nav-link" href="#_toc_authorization_interceptor" title="Authorization Interceptor">Authorization Interceptor</a>
    </li>
    <ul class="nav flex-column flex-nowrap nav-collapsible">
        <li class="h3">
        <a class="nav-link" href="#_toc_using_authorizationinterceptor_in_a_rest_server" title="Using AuthorizationInterceptor in a REST Server">Using AuthorizationInterceptor in a REST Server</a>
    </li>
    <li class="h3">
        <a class="nav-link" href="#_toc_authorizing_read_operations" title="Authorizing Read Operations">Authorizing Read Operations</a>
    </li>
    <li class="h3">
        <a class="nav-link" href="#_toc_authorizing_write_operations" title="Authorizing Write Operations">Authorizing Write Operations</a>
    </li>
    <li class="h3">
        <a class="nav-link" href="#_toc_authorizing_sub-operations" title="Authorizing Sub-Operations">Authorizing Sub-Operations</a>
    </li>
    <li class="h3">
        <a class="nav-link" href="#_toc_authorizing_patch_operations" title="Authorizing Patch Operations">Authorizing Patch Operations</a>
    </li>
    <li class="h3">
        <a class="nav-link" href="#_toc_authorizing_multitenant_servers" title="Authorizing Multitenant Servers">Authorizing Multitenant Servers</a>
    </li>
    </ul>
        <li class="h2">
        <a class="nav-link" href="#_toc_consent_interceptor" title="Consent Interceptor">Consent Interceptor</a>
    </li>
        <li class="h2">
        <a class="nav-link" href="#_toc_search_narrowing" title="Search Narrowing">Search Narrowing</a>
    </li>
                    </ul>
                </nav>
           </div>
            </div>
    </div> <!-- row: end -->
</div> <!-- .main-body: end -->
    <div id="m-scroll-top" style="display: none;">
        <a href="javascript:;">
            <div class="arrow"></div>
            <div class="stick"></div>
        </a>
    </div>
  <!-- Footer -->
  <footer class="footer-light bg-light">
    <div class="container">
        <div class="row">
        
            <div class="col bottom-nav">

                <ul class="nav flex-column nav-list">
                    <li class="nav-header">HAPI FHIR                    </li>
                    <li class="nav-item " )><a     
     href="index.html"  title="Home"  class="nav-link" >Home</a></li>
                    <li class="nav-item " )><a     
     href="download.html"  title="Download"  class="nav-link" >Download</a></li>
                    <li class="nav-item " )><a     
     href="changes-report.html"  title="Changelog"  class="nav-link" >Changelog</a></li>
                    <li class="nav-item " )><a     
     href="license.html"  title="License"  class="nav-link" >License</a></li>
                    <li class="nav-header">Test Server                    </li>
                    <li class="nav-item " )><a     
     href="http://hapi.fhir.org"  title="Public Test Server"   class="externalLink nav-link" >Public Test Server</a></li>
                </ul>
            </div>
            <div class="col bottom-nav">

                <ul class="nav flex-column nav-list">
                    <li class="nav-header">Using HAPI                    </li>
                    <li class="nav-item " )><a     
     href="docindex.html"  title="Documentation Index"  class="nav-link" >Documentation Index</a></li>
                    <li class="nav-item " )><a     
     href="doc_cli.html"  title="Command Line Tool (cli)"  class="nav-link" >Command Line Tool (cli)</a></li>
                    <li class="nav-header">Contribute                    </li>
                    <li class="nav-item " )><a     
     href="hacking_hapi_fhir.html"  title="Guide to Hacking HAPI"  class="nav-link" >Guide to Hacking HAPI</a></li>
                </ul>
            </div>
            <div class="col bottom-nav">

                <ul class="nav flex-column nav-list">
                    <li class="nav-header">JavaDocs                    </li>
                    <li class="nav-item " )><a     
     href="apidocs/index.html"  title="Core API"  class="nav-link" >Core API</a></li>
                    <li class="nav-item " )><a     
     href="apidocs-dstu/index.html"  title="Model API (DSTU1)"  class="nav-link" >Model API (DSTU1)</a></li>
                    <li class="nav-item " )><a     
     href="apidocs-dstu2/index.html"  title="Model API (DSTU2)"  class="nav-link" >Model API (DSTU2)</a></li>
                    <li class="nav-item " )><a     
     href="apidocs-dstu3/index.html"  title="Model API (DSTU3)"  class="nav-link" >Model API (DSTU3)</a></li>
                    <li class="nav-item " )><a     
     href="apidocs-r4/index.html"  title="Model API (R4)"  class="nav-link" >Model API (R4)</a></li>
                    <li class="nav-item " )><a     
     href="apidocs-client/index.html"  title="Client API"  class="nav-link" >Client API</a></li>
                    <li class="nav-item " )><a     
     href="apidocs-server/index.html"  title="Server API (Plain)"  class="nav-link" >Server API (Plain)</a></li>
                    <li class="nav-item " )><a     
     href="apidocs-jpaserver/index.html"  title="Server API (JPA)"  class="nav-link" >Server API (JPA)</a></li>
                    <li class="nav-header">JXR                    </li>
                    <li class="nav-item " )><a     
     href="xref-base/index.html"  title="Core"  class="nav-link" >Core</a></li>
                    <li class="nav-item " )><a     
     href="xref-jpaserver/index.html"  title="JPA Server"  class="nav-link" >JPA Server</a></li>
                </ul>
            </div>
            <div class="col bottom-nav">

                <ul class="nav flex-column nav-list">
                    <li class="nav-header">Get Help                    </li>
                    <li class="nav-item " )><a     
     href="https://github.com/jamesagnew/hapi-fhir/wiki/Getting-Help"  title="How to Ask for Help (read this first!)"   class="externalLink nav-link" >How to Ask for Help (read this first!)</a></li>
                    <li class="nav-item " )><a     
     href="https://groups.google.com/d/forum/hapi-fhir"  title="Google Group (Ask Questions)"   class="externalLink nav-link" >Google Group (Ask Questions)</a></li>
                    <li class="nav-item " )><a     
     href="https://github.com/jamesagnew/hapi-fhir/issues"  title="Issue Tracker (Report Bugs/Request Features)"   class="externalLink nav-link" >Issue Tracker (Report Bugs/Request Features)</a></li>
                    <li class="nav-item " )><a     
     href="https://chat.fhir.org"  title="FHIR.org Chat (Live Chat with FHIR Implementors)"   class="externalLink nav-link" >FHIR.org Chat (Live Chat with FHIR Implementors)</a></li>
                    <li class="nav-item " )><a     
     href="hapi-fhir-faq.html"  title="Frequently Asked Questions (FAQ)"  class="nav-link" >Frequently Asked Questions (FAQ)</a></li>
                </ul>
            </div>
        <div class="col bottom-description">
            <blockquote class="blockquote">HAPI FHIR is a Java implementation of the HL7 FHIR
				(Fast Healthcare Interoperable Resources) specification.
				This project is open source (licensed under the Apache Software
				License 2.0) and 100% free to use.<br/><br/>
				<a href="https://github.com/jamesagnew/hapi-fhir"><img src="./images/github-logo-mini.png" alt="Hosted on GitHub" border="0"/></a>
				<br/>
				Star us and we will love you!<br />
				<iframe src="https://ghbtns.com/github-btn.html?user=jamesagnew&repo=hapi-fhir&type=star&count=true" frameborder="0" scrolling="0" width="100px" height="20px"></iframe></blockquote>
        </div>
      </div>
    </div>
  </footer>
  <div class="container subfooter">
    <div class="row">
      <div class="col-md-12">
        <p class="copyright">Copyright &copy;2014-2019                 <a href="http://www.uhn.ca">University Health Network</a>
. All Rights Reserved.</p>
        <p class="version-date">
<span class="projectVersion">Version: 4.0.0-SNAPSHOT. </span><span class="publishDate">
    Last Published: 2019-08-09
. </span>        </p>
        <p><a href="https://github.com/devacfr/reflow-maven-skin" title="Reflow Maven skin">Reflow Maven skin</a> by <a href="http://devacfr.github.io" target="_blank" title="devacfr">devacfr</a>.</p>
      </div>
    </div>
  </div>

  <!-- Le javascript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/${popperVersion}/umd//popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>

  <script src="./js/lightbox.min.js"></script>
      <script src="./js/reflow-skin.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.2.2/anchor.min.js"></script>
    <script type="text/javascript">
	var elements = document.getElementsByClassName("source");
	for (var i=0; i < elements.length; i++) {
		var pres = elements[i].getElementsByTagName("pre");
		for (var j = 0; j < pres.length; j++) {
			var pre = pres[j];
			if (pre.innerHTML.match(/^\s*\&lt\;/)) {
				pre.className = 'brush: xml';
			} else if (pre.innerHTML.match(/\/\*/)) {
				pre.className = 'brush: java';
			} else if (pre.innerHTML.match(/^\/\//)) {
				pre.className = 'brush: java';
			} else if (pre.innerHTML.match(/^\{/)) {
				pre.className = 'brush: jscript';
			} else if (pre.innerHTML.match(/^\#/)) {
				pre.className = 'brush: bash';
			} else if (pre.innerHTML.match(/\&lt\;\//)) {
				pre.className = 'brush: xml';
			} else {
				pre.className = 'brush: java';
			}
		}
	}

	SyntaxHighlighter.all();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1395874-5', 'auto');
  ga('require', 'displayfeatures');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');

</script>
                </body >
</html>